{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - Nilan Clothing</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <style>
        /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
        .checkout-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .checkout-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .checkout-header h1 {
            font-size: 2.5rem;
            color: #4ecdc4; /* –Ø–†–ö–ò–ô –¶–í–ï–¢ */
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .checkout-header p {
            color: #4ecdc4; /* –Ø–†–ö–ò–ô –¶–í–ï–¢ */
            font-size: 1.2rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .checkout-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2.5rem;
            align-items: start;
        }

        /* –ë–õ–û–ö –§–û–†–ú–´ */
        .form-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #eef2f7;
        }

        .section-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 1.8rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #4ecdc4;
            font-weight: 600;
        }

        /* –§–û–†–ú–ê */
        .form-group {
            margin-bottom: 1.8rem;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .required::after {
            content: " *";
            color: #e74c3c;
        }

        .form-control {
            width: 100%;
            padding: 0.9rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            color: #2c3e50;
        }

        .form-control:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.15);
        }

        .form-control.error {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .form-control.success {
            border-color: #2ecc71;
            background: #f8fff9;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.2rem;
        }

        .error-popup {
            position: absolute;
            top: -45px;
            left: 0;
            background: #e74c3c;
            color: white;
            padding: 7px 14px;
            border-radius: 6px;
            font-size: 0.85rem;
            z-index: 1001;
            display: none;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .error-popup::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 20px;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #e74c3c;
        }

        /* –¢–ï–õ–ï–§–û–ù */
        .phone-group {
            display: flex;
            gap: 0.8rem;
            align-items: center;
        }

        .phone-prefix {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.9rem 1rem;
            font-weight: 600;
            color: #2c3e50;
            min-width: 70px;
            text-align: center;
            font-size: 1rem;
        }

        /* –ê–í–¢–û–ö–û–ú–ü–õ–ò–¢ */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #ffffff !important;
            border: 1px solid #e9ecef;
            border-radius: 0 0 8px 8px;
            z-index: 9999;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            color: #333 !important;
            border-bottom: 1px solid #f0f0f0;
            background: #fff !important;
        }

        .suggestion-item:hover {
            background-color: #4ecdc4 !important;
            color: #fff !important;
        }

        .invalid-field {
            border-color: #e74c3c !important;
        }

        .valid-field {
            border-color: #2ecc71 !important;
        }

        /* –ë–õ–û–ö –ó–ê–ö–ê–ó–ê */
        .order-summary-section {
            position: sticky;
            top: 2rem;
        }

        .order-summary-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #eef2f7;
        }

        .order-items {
            margin-bottom: 1.5rem;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-info h4 {
            margin: 0 0 0.3rem 0;
            font-size: 1rem;
            color: #2c3e50;
            font-weight: 600;
        }

        .item-info small {
            color: #666;
            font-size: 0.9rem;
        }

        .item-price {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        .order-total {
            padding-top: 1.5rem;
            border-top: 2px solid #4ecdc4;
            text-align: center;
        }

        .total-amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0.5rem 0;
        }

        .total-label {
            color: #666;
            font-size: 1rem;
        }

        /* –ö–ù–û–ü–ö–ê */
        .submit-btn {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* –°–ß–ï–¢–ß–ò–ö–ò –°–ò–ú–í–û–õ–û–í */
        .char-counter {
            text-align: right;
            font-size: 0.85rem;
            color: #888;
            margin-top: 0.3rem;
        }

        .char-counter.warning {
            color: #e67e22;
        }

        .char-counter.error {
            color: #e74c3c;
        }

        /* –°–ï–ö–¶–ò–Ø –û–ü–õ–ê–¢–´ */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
            margin-top: 0.5rem;
        }

        .payment-method {
            position: relative;
        }

        .payment-radio {
            display: none;
        }

        .payment-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background: white;
        }

        .payment-label:hover {
            border-color: #4ecdc4;
            transform: translateY(-2px);
        }

        .payment-radio:checked + .payment-label {
            border-color: #4ecdc4;
            background: #f0fafa;
            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.15);
        }

        .payment-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .payment-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
        }

        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 992px) {
            .checkout-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .order-summary-section {
                position: static;
            }

            .form-section,
            .order-summary-card {
                padding: 1.8rem;
            }
        }

        @media (max-width: 768px) {
            .checkout-header h1 {
                font-size: 2rem;
            }

            .checkout-header p {
                font-size: 1.1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .payment-methods {
                grid-template-columns: 1fr;
            }

            .form-section,
            .order-summary-card {
                padding: 1.5rem;
            }

            .submit-btn {
                padding: 1.1rem;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .checkout-container {
                padding: 1rem 0.5rem;
            }

            .checkout-header h1 {
                font-size: 1.8rem;
            }

            .checkout-header p {
                font-size: 1rem;
            }

            .section-title {
                font-size: 1.2rem;
            }

            .form-control {
                padding: 0.8rem;
                font-size: 16px;
            }

            .phone-group {
                flex-direction: column;
                align-items: stretch;
            }

            .phone-prefix {
                width: 100%;
            }

            .total-amount {
                font-size: 1.5rem;
            }
        }

        /* –ê–ù–ò–ú–ê–¶–ò–ò */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section,
        .order-summary-card {
            animation: fadeIn 0.5s ease;
        }

        /* –ò–ö–û–ù–ö–ò –î–õ–Ø –ü–û–õ–ï–ô */
        .form-control-with-icon {
            position: relative;
        }

        .form-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 1.1rem;
        }

        .form-control-with-icon .form-control {
            padding-left: 3rem;
        }

        .form-control-with-icon .form-icon {
            pointer-events: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <h1>Nilan Clothing</h1>
        </div>
        <nav>
            <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="{% url 'shop:product_list' %}">–ö–∞—Ç–∞–ª–æ–≥</a>
            <a href="{% url 'shop:cart_detail' %}">–ö–æ—Ä–∑–∏–Ω–∞</a>
            {% if user.is_authenticated %}
                <a href="{% url 'users:profile' %}">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
                <a href="{% url 'users:logout' %}">–í—ã–π—Ç–∏</a>
            {% else %}
                <a href="{% url 'users:login' %}">–í–æ–π—Ç–∏</a>
                <a href="{% url 'users:register' %}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            {% endif %}
        </nav>
    </header>

    <main>
        <div class="checkout-container">
            <div class="checkout-header">
                <h1>üõí –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
                <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –ø–æ–∫—É–ø–∫—É</p>
            </div>

            <div class="checkout-grid">
                <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –§–æ—Ä–º–∞ -->
                <div class="form-section">
                    <h2 class="section-title">üë§ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</h2>

                    <form method="post" id="orderForm" novalidate>
                        {% csrf_token %}

                        <!-- –§–ò–û —Å –æ—à–∏–±–∫–æ–π -->
                        <div class="form-group">
                            <label class="form-label required" for="id_customer_name">–§–ò–û</label>
                            <div class="form-control-with-icon">
                                <span class="form-icon">üë§</span>
                                <input type="text"
                                       name="customer_name"
                                       id="id_customer_name"
                                       class="form-control"
                                       placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                                       value="{{ form.customer_name.value|default:'' }}"
                                       required
                                       autocomplete="name"
                                       maxlength="100">
                            </div>
                            <div class="error-popup" id="name-popup">–¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–µ/–∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã, –ø—Ä–æ–±–µ–ª –∏ –¥–µ—Ñ–∏—Å</div>
                        </div>

                        <div class="form-row">
                            <!-- Email -->
                            <div class="form-group">
                                <label class="form-label required" for="id_customer_email">Email</label>
                                <div class="form-control-with-icon">
                                    <span class="form-icon">‚úâÔ∏è</span>
                                    <input type="email"
                                           name="customer_email"
                                           id="id_customer_email"
                                           class="form-control"
                                           placeholder="example@mail.ru"
                                           value="{{ form.customer_email.value|default:'' }}"
                                           required
                                           autocomplete="email">
                                </div>
                                <div class="error-popup" id="email-popup">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email (–ø—Ä–∏–º–µ—Ä: name@domain.ru)</div>
                            </div>

                            <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
                            <div class="form-group">
                                <label class="form-label required" for="id_customer_phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <div class="phone-group">
                                    <div class="phone-prefix">+7</div>
                                    <input type="tel"
                                           name="customer_phone"
                                           id="id_customer_phone"
                                           class="form-control"
                                           placeholder="(999) 123-45-67"
                                           value="{{ form.customer_phone.value|default:'' }}"
                                           required
                                           autocomplete="tel">
                                </div>
                                <div class="error-popup" id="phone-popup">–í–≤–µ–¥–∏—Ç–µ 10 —Ü–∏—Ñ—Ä –Ω–æ–º–µ—Ä–∞ (–ø—Ä–∏–º–µ—Ä: 9991234567)</div>
                            </div>
                        </div>

                        <!-- –ê–¥—Ä–µ—Å -->
                        <div class="form-group">
                            <label class="form-label required" for="id_shipping_address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                            <div class="form-control-with-icon">
                                <span class="form-icon">üè†</span>
                                <textarea name="shipping_address"
                                          id="id_shipping_address"
                                          class="form-control"
                                          placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 10, –∫–≤. 5"
                                          rows="3"
                                          required
                                          maxlength="200">{{ form.shipping_address.value|default:'' }}</textarea>
                            </div>
                            <div class="char-counter" id="addr-counter">0 / 200</div>
                            <div class="error-popup" id="address-popup">–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å</div>
                        </div>

                        <div class="form-row">
                            <!-- –ì–æ—Ä–æ–¥ —Å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º -->
                            <div class="form-group">
                                <label class="form-label required" for="id_shipping_city">–ì–æ—Ä–æ–¥</label>
                                <div class="autocomplete-container">
                                    <div class="form-control-with-icon">
                                        <span class="form-icon">üèôÔ∏è</span>
                                        <input type="text"
                                               name="shipping_city"
                                               id="id_shipping_city"
                                               class="form-control"
                                               placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥"
                                               value="{{ form.shipping_city.value|default:'' }}"
                                               required
                                               autocomplete="off">
                                    </div>
                                    <div class="autocomplete-suggestions" id="city-suggestions"></div>
                                </div>
                                <div class="error-popup" id="city-popup">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞</div>
                            </div>

                            <!-- –ò–Ω–¥–µ–∫—Å -->
                            <div class="form-group">
                                <label class="form-label required" for="id_shipping_zip_code">–ü–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å</label>
                                <div class="form-control-with-icon">
                                    <span class="form-icon">üìÆ</span>
                                    <input type="text"
                                           name="shipping_zip_code"
                                           id="id_shipping_zip_code"
                                           class="form-control"
                                           placeholder="123456"
                                           value="{{ form.shipping_zip_code.value|default:'' }}"
                                           required
                                           maxlength="6"
                                           autocomplete="postal-code">
                                </div>
                                <div class="error-popup" id="zip-popup">–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, —Ä–æ–≤–Ω–æ 6 —Å–∏–º–≤–æ–ª–æ–≤</div>
                            </div>
                        </div>

                        <input type="hidden" name="shipping_country" value="–†–æ—Å—Å–∏—è">

                        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                        <div class="form-group">
                            <label class="form-label" for="id_shipping_comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
                            <div class="form-control-with-icon">
                                <span class="form-icon">üí¨</span>
                                <textarea name="shipping_comment"
                                          id="id_shipping_comment"
                                          class="form-control"
                                          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–¥—ä–µ–∑–¥ 2, —ç—Ç–∞–∂ 4, –¥–æ–º–æ—Ñ–æ–Ω 12"
                                          rows="2"
                                          maxlength="100">{{ form.shipping_comment.value|default:'' }}</textarea>
                            </div>
                            <div class="char-counter" id="comm-counter">0 / 100</div>
                        </div>

                        <!-- –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
                        <h2 class="section-title" style="margin-top: 2.5rem;">üí≥ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h2>

                        <div class="payment-methods">
                            {% for value, label in form.payment_method.field.choices %}
                            <div class="payment-method">
                                <input type="radio"
                                       name="payment_method"
                                       id="payment_{{ value }}"
                                       value="{{ value }}"
                                       class="payment-radio"
                                       {% if value == form.payment_method.value|default:'card' %}checked{% endif %}>
                                <label for="payment_{{ value }}" class="payment-label">
                                    <span class="payment-icon">
                                        {% if value == 'card' %}üí≥
                                        {% elif value == 'cash' %}üíµ
                                        {% elif value == 'online' %}üåê
                                        {% endif %}
                                    </span>
                                    <span class="payment-name">{{ label|slice:"2:" }}</span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                        <button type="submit" class="submit-btn" id="submitBtn">
                            <span>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</span>
                            <span>‚Üí</span>
                        </button>
                    </form>
                </div>

                <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –°–≤–æ–¥–∫–∞ –∑–∞–∫–∞–∑–∞ -->
                <div class="order-summary-section">
                    <div class="order-summary-card">
                        <h2 class="section-title">üì¶ –í–∞—à –∑–∞–∫–∞–∑</h2>

                        <div class="order-items">
                            {% for item in cart_items %}
                            <div class="order-item">
                                <div class="item-info">
                                    <h4>{{ item.product.name }}</h4>
                                    <small>{{ item.quantity }} —à—Ç. √ó {{ item.product.price }} —Ä—É–±.</small>
                                </div>
                                <div class="item-price">{{ item.get_total_price }} —Ä—É–±.</div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="order-total">
                            <div class="total-label">–û–±—â–∞—è —Å—É–º–º–∞:</div>
                            <div class="total-amount">{{ total_price }} —Ä—É–±.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="footer-content">
            <div class="social-links">
                <h3>–ú—ã –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö</h3>
                <div class="social-icons">
                    <a href="#" class="social-link">Telegram</a>
                    <a href="#" class="social-link">VK</a>
                </div>
            </div>

            <div class="copyright">
                <p>&copy; {% now "Y" %} Nilan Clothing. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
                <p>–°–∞–π—Ç —Å–æ–∑–¥–∞–Ω —Å ‚ù§Ô∏è –¥–ª—è —Ñ–∞–Ω–∞—Ç–æ–≤ —Å—Ç–∏–ª—è</p>
                <p><a href="#" id="openPolicy" style="color: #4ecdc4; text-decoration: underline; cursor: pointer;">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a></p>
            </div>
        </div>
    </footer>
<div id="policyModal" class="modal">
    <div class="modal-content">
        {% include 'privacy_policy.html' %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const confirmed = { 'id_shipping_city': '' };
        let validationTimeout;

        // --- –í–ê–õ–ò–î–ê–¶–ò–Ø –§–ò–û ---
        const nameInput = document.getElementById('id_customer_name');
        const namePopup = document.getElementById('name-popup');

        nameInput.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which);
            if (!/[a-zA-Z–∞-—è–ê-–Ø—ë–Å\s\-]/.test(char)) {
                e.preventDefault();
                showError(namePopup, '–¶–∏—Ñ—Ä—ã –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã');
            }

            if ((char === ' ' || char === '-') && this.selectionStart === 0) {
                e.preventDefault();
                showError(namePopup, '–ù–µ–ª—å–∑—è –Ω–∞—á–∏–Ω–∞—Ç—å —Å –ø—Ä–æ–±–µ–ª–∞ –∏–ª–∏ –¥–µ—Ñ–∏—Å–∞');
            }
        });

        nameInput.addEventListener('input', function() {
            clearTimeout(validationTimeout);
            validationTimeout = setTimeout(() => validateName(), 300);
        });

        function validateName() {
            let value = nameInput.value;

            if (/^[\s\-]/.test(value)) {
                nameInput.value = value.replace(/^[\s\-]+/, '');
                value = nameInput.value;
                showError(namePopup, '–ù–µ–ª—å–∑—è –Ω–∞—á–∏–Ω–∞—Ç—å —Å –ø—Ä–æ–±–µ–ª–∞ –∏–ª–∏ –¥–µ—Ñ–∏—Å–∞');
            }

            if (/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å\s\-]/.test(value)) {
                nameInput.value = value.replace(/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å\s\-]/g, '');
                value = nameInput.value;
                showError(namePopup, '–¶–∏—Ñ—Ä—ã –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã —É–¥–∞–ª–µ–Ω—ã');
            }

            const isValid = value.length >= 2 && !value.includes('  ') && !value.includes('--');

            if (isValid && value.length > 0) {
                nameInput.value = value.split(/\s+/).map(word => {
                    if (word.includes('-')) {
                        return word.split('-').map(part =>
                            part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
                        ).join('-');
                    }
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }).join(' ');
            }

            updateFieldBorder(nameInput, isValid);
            namePopup.style.display = isValid ? 'none' : 'block';
            return isValid;
        }

        // --- –í–ê–õ–ò–î–ê–¶–ò–Ø EMAIL ---
        const emailInput = document.getElementById('id_customer_email');
        const emailPopup = document.getElementById('email-popup');

        emailInput.addEventListener('input', function() {
            clearTimeout(validationTimeout);
            validationTimeout = setTimeout(() => validateEmail(), 300);
        });

        function validateEmail() {
            const value = emailInput.value.trim();
            const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(value);

            updateFieldBorder(emailInput, isValid);
            emailPopup.style.display = isValid ? 'none' : 'block';
            return isValid;
        }

        // --- –í–ê–õ–ò–î–ê–¶–ò–Ø –¢–ï–õ–ï–§–û–ù–ê ---
        const phoneInput = document.getElementById('id_customer_phone');
        const phonePopup = document.getElementById('phone-popup');

        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');

            if (value.length > 10) {
                value = value.substring(0, 10);
            }

            if (value.length === 0) {
                e.target.value = '';
            } else if (value.length <= 3) {
                e.target.value = '(' + value;
            } else if (value.length <= 6) {
                e.target.value = '(' + value.substring(0, 3) + ') ' + value.substring(3);
            } else if (value.length <= 8) {
                e.target.value = '(' + value.substring(0, 3) + ') ' + value.substring(3, 6) + '-' + value.substring(6);
            } else {
                e.target.value = '(' + value.substring(0, 3) + ') ' + value.substring(3, 6) + '-' + value.substring(6, 8) + '-' + value.substring(8, 10);
            }

            clearTimeout(validationTimeout);
            validationTimeout = setTimeout(() => validatePhone(), 300);
        });

        function validatePhone() {
            const phoneDigits = phoneInput.value.replace(/\D/g, '');
            const isValid = phoneDigits.length === 10;

            updateFieldBorder(phoneInput, isValid);
            phonePopup.style.display = isValid ? 'none' : 'block';
            return isValid;
        }

        // --- –í–ê–õ–ò–î–ê–¶–ò–Ø –ê–î–†–ï–°–ê ---
        const addressInput = document.getElementById('id_shipping_address');
        const addressPopup = document.getElementById('address-popup');

        addressInput.addEventListener('input', function() {
            clearTimeout(validationTimeout);
            validationTimeout = setTimeout(() => validateAddress(), 300);

            document.getElementById('addr-counter').textContent = `${addressInput.value.length} / 200`;

            if (addressInput.value.length === 1) {
                addressInput.value = addressInput.value.charAt(0).toUpperCase();
            }
        });

        function validateAddress() {
            const value = addressInput.value.trim();
            const isValid = value.length >= 5;

            updateFieldBorder(addressInput, isValid);
            addressPopup.style.display = isValid ? 'none' : 'block';
            return isValid;
        }

        // --- –ê–í–¢–û–ö–û–ú–ü–õ–ò–¢ –ì–û–†–û–î–ê ---
        function setupCitySearch() {
            const input = document.getElementById('id_shipping_city');
            const popup = document.getElementById('city-popup');
            const suggestions = document.getElementById('city-suggestions');
            input.setAttribute('autocomplete', 'off');

            input.addEventListener('keydown', (e) => {
                if ((e.key === ' ' || e.key === '-') && input.selectionStart === 0) {
                    e.preventDefault();
                    showError(popup, '–ù–µ–ª—å–∑—è –Ω–∞—á–∏–Ω–∞—Ç—å —Å –ø—Ä–æ–±–µ–ª–∞ –∏–ª–∏ –¥–µ—Ñ–∏—Å–∞');
                }
            });

            input.addEventListener('input', function() {
                let val = this.value;

                if (/^[\s\-]/.test(val)) {
                    this.value = val.replace(/^[\s\-]+/, '');
                    val = this.value;
                    showError(popup, '–ù–µ–ª—å–∑—è –Ω–∞—á–∏–Ω–∞—Ç—å —Å –ø—Ä–æ–±–µ–ª–∞ –∏–ª–∏ –¥–µ—Ñ–∏—Å–∞');
                }

                if (/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å\s\-]/.test(val)) {
                    this.value = val.replace(/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å\s\-]/g, '');
                    val = this.value;
                    showError(popup, '–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ—Ñ–∏—Å');
                }

                if (val.length === 1) {
                    this.value = val.charAt(0).toUpperCase();
                    val = this.value;
                }

                input.classList.remove('invalid-field', 'valid-field');
                popup.style.display = 'none';

                if (val.length < 1) {
                    suggestions.style.display = 'none';
                    return;
                }

                let formatted = val.charAt(0).toUpperCase() + val.slice(1);

                fetch(`/shop/api/locations/?term=${encodeURIComponent(formatted)}&type=city`)
                    .then(r => r.json())
                    .then(data => {
                        suggestions.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(name => {
                                const item = document.createElement('div');
                                item.className = 'suggestion-item';
                                item.textContent = name;
                                item.onclick = () => {
                                    input.value = name;
                                    confirmed['id_shipping_city'] = name;
                                    suggestions.style.display = 'none';
                                    input.classList.remove('invalid-field');
                                    input.classList.add('valid-field');
                                    popup.style.display = 'none';
                                };
                                suggestions.appendChild(item);
                            });
                            suggestions.style.display = 'block';
                        } else {
                            suggestions.style.display = 'none';
                        }
                    })
                    .catch(() => suggestions.style.display = 'none');
            });

            input.addEventListener('blur', () => {
                setTimeout(() => {
                    suggestions.style.display = 'none';
                    if (input.value && input.value !== confirmed['id_shipping_city']) {
                        input.classList.add('invalid-field');
                        popup.style.display = 'block';
                    }
                }, 250);
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });
        }

        setupCitySearch();

        // --- –í–ê–õ–ò–î–ê–¶–ò–Ø –ò–ù–î–ï–ö–°–ê ---
        const zipInput = document.getElementById('id_shipping_zip_code');
        const zipPopup = document.getElementById('zip-popup');

        zipInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');

            if (this.value.length > 6) {
                this.value = this.value.substring(0, 6);
            }

            clearTimeout(validationTimeout);
            validationTimeout = setTimeout(() => validateZip(), 300);
        });

        function validateZip() {
            const value = zipInput.value;
            const isValid = value.length === 6 && /^\d+$/.test(value);

            updateFieldBorder(zipInput, isValid);
            zipPopup.style.display = isValid ? 'none' : 'block';
            return isValid;
        }

        // --- –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô ---
        const commentInput = document.getElementById('id_shipping_comment');

        commentInput.addEventListener('input', () => {
            if (commentInput.value.length > 100) {
                commentInput.value = commentInput.value.substring(0, 100);
            }

            document.getElementById('comm-counter').textContent = `${commentInput.value.length} / 100`;
        });

        // --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ---
        const policyModal = document.getElementById('policyModal');
        const openPolicyBtn = document.getElementById('openPolicy');

        if (openPolicyBtn) {
            openPolicyBtn.addEventListener('click', function(e) {
                e.preventDefault();
                policyModal.style.display = 'block';
            });

            window.addEventListener('click', function(e) {
                if (e.target == policyModal) {
                    policyModal.style.display = 'none';
                }
            });
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function showError(popup, message) {
            popup.textContent = message;
            popup.style.display = 'block';
            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);
        }

        function updateFieldBorder(field, isValid) {
            field.classList.remove('invalid-field', 'valid-field');
            if (field.value.trim() !== '') {
                field.classList.add(isValid ? 'valid-field' : 'invalid-field');
            }
        }

        // --- –û–¢–ü–†–ê–í–ö–ê –§–û–†–ú–´ ---
        document.getElementById('orderForm').onsubmit = function(e) {
            let hasError = false;

            if (!validateName()) {
                nameInput.classList.add('invalid-field');
                namePopup.style.display = 'block';
                hasError = true;
            }

            if (!validateEmail()) {
                emailInput.classList.add('invalid-field');
                emailPopup.style.display = 'block';
                hasError = true;
            }

            if (!validatePhone()) {
                phoneInput.classList.add('invalid-field');
                phonePopup.style.display = 'block';
                hasError = true;
            }

            if (!validateAddress()) {
                addressInput.classList.add('invalid-field');
                addressPopup.style.display = 'block';
                hasError = true;
            }

            if (!validateZip()) {
                zipInput.classList.add('invalid-field');
                zipPopup.style.display = 'block';
                hasError = true;
            }

            const cityInput = document.getElementById('id_shipping_city');
            if (cityInput.value !== confirmed['id_shipping_city']) {
                cityInput.classList.add('invalid-field');
                document.getElementById('city-popup').style.display = 'block';
                hasError = true;
            }

            const paymentSelected = document.querySelector('input[name="payment_method"]:checked');
            if (!paymentSelected) {
                hasError = true;
            }

            if (hasError) {
                e.preventDefault();
                const firstError = document.querySelector('.invalid-field');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.getElementById('addr-counter').textContent = `${addressInput.value.length} / 200`;
        document.getElementById('comm-counter').textContent = `${commentInput.value.length} / 100`;

        setTimeout(() => {
            if (nameInput.value) validateName();
            if (emailInput.value) validateEmail();
            if (phoneInput.value) validatePhone();
            if (addressInput.value) validateAddress();
            if (zipInput.value) validateZip();
        }, 100);
    });
</script>
</body>
</html>

